<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>dylib动态库加载过程分析 | fEICOnG&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Windows系统的动态库是DLL文件，Linux系统是so文件，macOS系统的动态库则使用dylib文件作为动态库。dylib本质上是一个Mach-O格式的文件，它与普通的Mach-O执行文件几乎使用一样的结构，只是在文件类型上一个是MH_DYLIB，一个是MH_EXECUTE。在系统的/usr/lib目录下，存放了大量供系统与应用程序调用的动态库文件，使用file命令查看系统动态库libob">
<meta property="og:type" content="article">
<meta property="og:title" content="dylib动态库加载过程分析">
<meta property="og:url" content="https://feicong.github.io/2017/01/14/dylib/index.html">
<meta property="og:site_name" content="fEICOnG's Blog">
<meta property="og:description" content="Windows系统的动态库是DLL文件，Linux系统是so文件，macOS系统的动态库则使用dylib文件作为动态库。dylib本质上是一个Mach-O格式的文件，它与普通的Mach-O执行文件几乎使用一样的结构，只是在文件类型上一个是MH_DYLIB，一个是MH_EXECUTE。在系统的/usr/lib目录下，存放了大量供系统与应用程序调用的动态库文件，使用file命令查看系统动态库libob">
<meta property="og:updated_time" content="2017-01-14T01:47:34.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dylib动态库加载过程分析">
<meta name="twitter:description" content="Windows系统的动态库是DLL文件，Linux系统是so文件，macOS系统的动态库则使用dylib文件作为动态库。dylib本质上是一个Mach-O格式的文件，它与普通的Mach-O执行文件几乎使用一样的结构，只是在文件类型上一个是MH_DYLIB，一个是MH_EXECUTE。在系统的/usr/lib目录下，存放了大量供系统与应用程序调用的动态库文件，使用file命令查看系统动态库libob">
  
    <link rel="alternate" href="/atom.xml" title="fEICOnG&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">fEICOnG&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">RE makes life easier</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://feicong.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-dylib" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/14/dylib/" class="article-date">
  <time datetime="2017-01-14T01:42:58.000Z" itemprop="datePublished">2017-01-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      dylib动态库加载过程分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Windows系统的动态库是DLL文件，Linux系统是so文件，macOS系统的动态库则使用dylib文件作为动态库。<br>dylib本质上是一个Mach-O格式的文件，它与普通的Mach-O执行文件几乎使用一样的结构，只是在文件类型上一个是<code>MH_DYLIB</code>，一个是<code>MH_EXECUTE</code>。<br>在系统的/usr/lib目录下，存放了大量供系统与应用程序调用的动态库文件，使用<code>file</code>命令查看系统动态库libobjc.dylib的信息，输出如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ file /usr/lib/libobjc.dylib</div><div class="line">/usr/lib/libobjc.dylib: Mach-O universal binary with 3 architectures</div><div class="line">/usr/lib/libobjc.dylib (for architecture i386):	Mach-O dynamically linked shared library i386</div><div class="line">/usr/lib/libobjc.dylib (for architecture x86_64):	Mach-O 64-bit dynamically linked shared library x86_64</div><div class="line">/usr/lib/libobjc.dylib (for architecture x86_64h):	Mach-O 64-bit dynamically linked shared library x86_64</div></pre></td></tr></table></figure></p>
<p>从上面的输出信息可以看出，libobjc.dylib是一个通用的二进制文件，包含了三种cpu架构的Mach-O。另外，<br>可以使用Mach-O格式文件管理工具<code>otool</code>查看dylib的信息，如查看动态库的依赖库信息如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ otool -L /usr/lib/libobjc.dylib</div><div class="line">/usr/lib/libobjc.dylib:</div><div class="line">	/usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)</div><div class="line">	/usr/lib/libauto.dylib (compatibility version 1.0.0, current version 1.0.0)</div><div class="line">	/usr/lib/libc++abi.dylib (compatibility version 1.0.0, current version 125.0.0)</div><div class="line">	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 120.1.0)</div><div class="line">	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1225.0.0)</div></pre></td></tr></table></figure></p>
<h2 id="0x1-构建动态库"><a href="#0x1-构建动态库" class="headerlink" title="0x1 构建动态库"></a>0x1 构建动态库</h2><p><code>XCode</code>环境提供了创建动态库的工程模板，创建动态库的方法比较简单，在<code>XCode</code>中选择File-&gt;New-&gt;Project，在打开的工程模选择对话框中，选择标签macOS-&gt;Framework &amp; Library，在右侧选择Library，点击Next按钮，在新页面中输入项目名称mylib，Type选择Dynamic，单击Next按钮选择项目保存的路径后，工程就创建好了。接着修改工程文件内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//mylib.h</div><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">@interface mylib : NSObject</div><div class="line">-(void) hello;</div><div class="line">@end</div><div class="line"></div><div class="line">//mylib.m</div><div class="line">#import &quot;mylib.h&quot;</div><div class="line"></div><div class="line">@implementation mylib</div><div class="line">-(void) hello &#123;</div><div class="line">    NSLog(@&quot;hello world&quot;);</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>保存后。觇击菜单Product-&gt;Build，或者按键般的COMMAND+B键就编译成功了。命令执行完后，就会生成mylib.dylib文件。<br>XCode创建的项目是xcodeproj文件，可以使用XCode提供的工具xcodebuild在命令行下编译，在命令行下切换到工程文件所在的目录后，执行<code>xcodebuild</code>会有如下输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">$ xcodebuild</div><div class="line">=== BUILD TARGET mylib OF PROJECT mylib WITH THE DEFAULT CONFIGURATION (Release) ===</div><div class="line"></div><div class="line">Check dependencies</div><div class="line"></div><div class="line">Write auxiliary files</div><div class="line">write-file /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/mylib-own-target-headers.hmap</div><div class="line">write-file /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/mylib-all-non-framework-target-headers.hmap</div><div class="line">......</div><div class="line">/bin/mkdir -p /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/Objects-normal/x86_64</div><div class="line">write-file /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/Objects-normal/x86_64/mylib.LinkFileList</div><div class="line"></div><div class="line">CompileC build/mylib.build/Release/mylib.build/Objects-normal/x86_64/mylib.o mylib/mylib.m normal x86_64 objective-c com.apple.compilers.llvm.clang.1_0.compiler</div><div class="line">    cd /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib</div><div class="line">    export LANG=en_US.US-ASCII</div><div class="line">    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -x objective-c -arch x86_64 -fmessage-length=94 -fdiagnostics-show-note-include-stack -fmacro-backtrace-limit=0 -fcolor-diagnostics -std=gnu99 -fobjc-arc -fmodules -gmodules -fmodules-prune-interval=86400 -fmodules-prune-after=345600 -fbuild-session-file=/var/folders/rd/mts0362j0n92rq0z1cnmdb580000gn/C/org.llvm.clang/ModuleCache/Session.modulevalidation -fmodules-validate-once-per-build-session -Wnon-modular-include-in-framework-module -Werror=non-modular-include-in-framework-module -Wno-trigraphs -fpascal-strings -Os -fno-common -Wno-missing-field-initializers -Wno-missing-prototypes -Werror=return-type -Wunreachable-code -Wno-implicit-atomic-properties -Werror=deprecated-objc-isa-usage -Werror=objc-root-class -Wno-arc-repeated-use-of-weak -Wduplicate-method-match -Wno-missing-braces -Wparentheses -Wswitch -Wunused-function -Wno-unused-label -Wno-unused-parameter -Wunused-variable -Wunused-value -Wempty-body -Wconditional-uninitialized -Wno-unknown-pragmas -Wno-shadow -Wno-four-char-constants -Wno-conversion -Wconstant-conversion -Wint-conversion -Wbool-conversion -Wenum-conversion -Wshorten-64-to-32 -Wpointer-sign -Wno-newline-eof -Wno-selector -Wno-strict-selector-match -Wundeclared-selector -Wno-deprecated-implementations -DNS_BLOCK_ASSERTIONS=1 -DOBJC_OLD_DISPATCH_PROTOTYPES=0 -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.11.sdk -fasm-blocks -fstrict-aliasing -Wprotocol -Wdeprecated-declarations -mmacosx-version-min=10.11 -g -Wno-sign-conversion -iquote /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/mylib-generated-files.hmap -I/Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/mylib-own-target-headers.hmap -I/Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/mylib-all-target-headers.hmap -iquote /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/mylib-project-headers.hmap -I/Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/Release/include -I/Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/DerivedSources/x86_64 -I/Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/DerivedSources -F/Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/Release -MMD -MT dependencies -MF /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/Objects-normal/x86_64/mylib.d --serialize-diagnostics /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/Objects-normal/x86_64/mylib.dia -c /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/mylib/mylib.m -o /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/Objects-normal/x86_64/mylib.o</div><div class="line"></div><div class="line">Ld build/Release/libmylib.dylib normal x86_64</div><div class="line">    cd /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib</div><div class="line">    export MACOSX_DEPLOYMENT_TARGET=10.11</div><div class="line">    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -arch x86_64 -dynamiclib -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.11.sdk -L/Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/Release -F/Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/Release -filelist /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/Objects-normal/x86_64/mylib.LinkFileList -install_name /usr/local/lib/libmylib.dylib -mmacosx-version-min=10.11 -fobjc-arc -fobjc-link-runtime -single_module -compatibility_version 1 -current_version 1 -Xlinker -dependency_info -Xlinker /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/mylib.build/Release/mylib.build/Objects-normal/x86_64/mylib_dependency_info.dat -o /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/Release/libmylib.dylib</div><div class="line"></div><div class="line">GenerateDSYMFile build/Release/libmylib.dylib.dSYM build/Release/libmylib.dylib</div><div class="line">    cd /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib</div><div class="line">    /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/dsymutil /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/Release/libmylib.dylib -o /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/Release/libmylib.dylib.dSYM</div><div class="line"></div><div class="line">CodeSign build/Release/libmylib.dylib</div><div class="line">    cd /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib</div><div class="line">    export CODESIGN_ALLOCATE=/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/codesign_allocate</div><div class="line"></div><div class="line">Signing Identity:     &quot;-&quot;</div><div class="line"></div><div class="line">    /usr/bin/codesign --force --sign - --timestamp=none /Users/macbook/Documents/macbook/macbook/code/chapter4/mylib/build/Release/libmylib.dylib</div><div class="line"></div><div class="line">** BUILD SUCCEEDED **</div></pre></td></tr></table></figure></p>
<p>从上面的日志中可以看出，整个编译过程分为：<br>检查依赖（Check dependencies）、生成辅助文件（Write auxiliary files）、编译（CompileC）、链接（Ld）、生成调试符号（GenerateDSYMFile）、代码签名（CodeSign）等几步。<br>编译代码时，使用的编译器是<code>clang</code>，这是苹果公司开发的用来替代<code>gcc</code>的现代化编译器，该编译器目前也广泛用于安卓、Linux平台上的软件开发工作；链接时使用<code>clang</code>前端传入参数给链接器<code>ld</code>，链接完成后dylib动态库就编译成功了；生成调试符号这一步主要用于生成符号的调试信息，供调试器使用；最后一步是代码签名，在没有指定签名证书的情况下，XCode默认使用的adhoc签名。</p>
<p>编译好的动态库可以被其它程序通过头文件声明隐式的调用，也可以像Linux系统那样，使用系统函数<code>dlopen()</code>、<code>dlsym()</code>手动进行调用。</p>
<h2 id="0x2-dyld"><a href="#0x2-dyld" class="headerlink" title="0x2 dyld"></a>0x2 dyld</h2><p>动态库不能直接运行，而是需要通过系统的动态链接加载器进行加载到内存后执行，动态链接加载器在系统中以一个用户态的可执行文件形式存在，一般应用程序会在Mach-O文件部分指定一个<code>LC_LOAD_DYLINKER</code>的加载命令，此加载命令指定了dyld的路径，通常它的默认值是“/usr/lib/dyld”。系统内核在加载Mach-O文件时，会使用该路径指定的程序作为动态库的加载器来加载dylib。</p>
<p>dyld加载时，为了优化程序启动，启用了共享缓存（shared cache）技术。共享缓存会在进程启动时被dyld映射到内存中，之后，当任何Mach-O映像加载时，dyld首先会检查该Mach-O映像与所需的动态库是否在共享缓存中，如果存在，则直接将它在共享内存中的内存地址映射到进程的内存地址空间。在程序依赖的系统动态库很多的情况下，这种做法对程序启动性能是有明显提升的。</p>
<p><code>update_dyld_shared_cache</code>程序确保了dyld的共享缓存是最新的，它会扫描/var/db/dyld/shared_region_roots/目录下paths路径文件，这些paths文件包含了需要加入到共享缓存的Mach-O文件路径列表，<code>update_dyld_shared_cache()</code>会挨个将这些Mach-O文件及其依赖的dylib都加共享缓存中去。</p>
<p>共享缓存是以文件形式存放在/var/db/dyld/目录下的，生成共享缓存的<code>update_dyld_shared_cache</code>程序位于是/usr/bin/目录下，该工具会为每种系统加构生成一个缓存文件与对应的内存地址map表，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ls -l /var/db/dyld/</div><div class="line">total 1741296</div><div class="line">-rw-r--r--   1 root  wheel  333085108 Apr 22 15:02 dyld_shared_cache_i386</div><div class="line">-rw-r--r--   1 root  wheel      65378 Apr 22 15:02 dyld_shared_cache_i386.map</div><div class="line">-rw-r--r--   1 root  wheel  558259294 Apr 25 16:18 dyld_shared_cache_x86_64h</div><div class="line">-rw-r--r--   1 root  wheel     129633 Apr 25 16:18 dyld_shared_cache_x86_64h.map</div><div class="line">drwxr-xr-x  10 root  wheel        340 Apr  7 09:19 shared_region_roots</div></pre></td></tr></table></figure></p>
<p>生成的共享缓存可以使用工具<code>dyld_shared_cache_util</code>查看它的信息，该工具位于dyld源码中的 launch-cache\dyld_shared_cache_util.cpp 文件，需要自己手动编译。另外，也可以使用dyld提供的两个函数<code>dyld_shared_cache_extract_dylibs()</code>与<code>dyld_shared_cache_extract_dylibs_progress()</code>来自己解开cache文件，代码位于dyld源码的launch-cache\dsc_extractor.cpp文件中。</p>
<p><code>update_dyld_shared_cache</code>通常它只在系统的安装器安装软件与系统更新时调用，当然，可以手动运行“sudo update_dyld_shared_cache”来更新共享缓存。新的共享缓存会在系统下次启动后自动更新。</p>
<h2 id="0x3-动态库的加载过程分析"><a href="#0x3-动态库的加载过程分析" class="headerlink" title="0x3 动态库的加载过程分析"></a>0x3 动态库的加载过程分析</h2><p>dyld是苹果操作系统一个重要组成部分，而且令人兴奋的是，它是开源的，任何人可以通过苹果官网下载它的源码来阅读理解它的运作方式（下载地址：<a href="http://opensource.apple.com/tarballs/dyld），了解系统加载动态库的细节。" target="_blank" rel="external">http://opensource.apple.com/tarballs/dyld），了解系统加载动态库的细节。</a></p>
<p>系统内核在加载动态库前，会加载dyld，然后调用去执行<code>__dyld_start()</code>，该函数会执行<code>dyldbootstrap::start()</code>，后者会执行<code>_main()</code>函数，dyld的加载动态库的代码就是从<code>_main()</code>开始执行的。下面以dyld源码的360.18版本为蓝本进行分析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line">uintptr_t</div><div class="line">_main(const macho_header* mainExecutableMH, uintptr_t mainExecutableSlide,</div><div class="line">		int argc, const char* argv[], const char* envp[], const char* apple[],</div><div class="line">		uintptr_t* startGlue)</div><div class="line">&#123;</div><div class="line">    //第一步，设置运行环境，处理环境变量</div><div class="line">	uintptr_t result = 0;</div><div class="line">	sMainExecutableMachHeader = mainExecutableMH;</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">	CRSetCrashLogMessage(&quot;dyld: launch started&quot;);</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">	setContext(mainExecutableMH, argc, argv, envp, apple);</div><div class="line"></div><div class="line">	// Pickup the pointer to the exec path.</div><div class="line">	sExecPath = _simple_getenv(apple, &quot;executable_path&quot;);</div><div class="line"></div><div class="line">	// &lt;rdar://problem/13868260&gt; Remove interim apple[0] transition code from dyld</div><div class="line">	if (!sExecPath) sExecPath = apple[0];</div><div class="line"></div><div class="line">	......</div><div class="line"></div><div class="line">	sExecShortName = ::strrchr(sExecPath, &apos;/&apos;);</div><div class="line">	if ( sExecShortName != NULL )</div><div class="line">		++sExecShortName;</div><div class="line">	else</div><div class="line">		sExecShortName = sExecPath;</div><div class="line">    sProcessIsRestricted = processRestricted(mainExecutableMH, &amp;ignoreEnvironmentVariables, &amp;sProcessRequiresLibraryValidation);</div><div class="line">    if ( sProcessIsRestricted ) &#123;</div><div class="line">#if SUPPORT_LC_DYLD_ENVIRONMENT</div><div class="line">		checkLoadCommandEnvironmentVariables();</div><div class="line">#endif 	</div><div class="line">		pruneEnvironmentVariables(envp, &amp;apple);</div><div class="line">		setContext(mainExecutableMH, argc, argv, envp, apple);</div><div class="line">	&#125;</div><div class="line">	else &#123;</div><div class="line">		if ( !ignoreEnvironmentVariables )</div><div class="line">			checkEnvironmentVariables(envp);</div><div class="line">		defaultUninitializedFallbackPaths(envp);</div><div class="line">	&#125;</div><div class="line">	if ( sEnv.DYLD_PRINT_OPTS )</div><div class="line">		printOptions(argv);</div><div class="line">	if ( sEnv.DYLD_PRINT_ENV )</div><div class="line">		printEnvironmentVariables(envp);</div><div class="line">	getHostInfo(mainExecutableMH, mainExecutableSlide);</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line"></div><div class="line">    //第二步，初始化主程序</div><div class="line">	try &#123;</div><div class="line">		// add dyld itself to UUID list</div><div class="line">		addDyldImageToUUIDList();</div><div class="line">		CRSetCrashLogMessage(sLoadingCrashMessage);</div><div class="line">		// instantiate ImageLoader for main executable</div><div class="line">		sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath);</div><div class="line">		gLinkContext.mainExecutable = sMainExecutable;</div><div class="line">		gLinkContext.processIsRestricted = sProcessIsRestricted;</div><div class="line">		gLinkContext.processRequiresLibraryValidation = sProcessRequiresLibraryValidation;</div><div class="line">		gLinkContext.mainExecutableCodeSigned = hasCodeSignatureLoadCommand(mainExecutableMH);</div><div class="line"></div><div class="line">        ......</div><div class="line"></div><div class="line">		//第三步，加载共享缓存</div><div class="line">		checkSharedRegionDisable();</div><div class="line">	#if DYLD_SHARED_CACHE_SUPPORT</div><div class="line">		if ( gLinkContext.sharedRegionMode != ImageLoader::kDontUseSharedRegion )</div><div class="line">			mapSharedCache();</div><div class="line">	#endif</div><div class="line"></div><div class="line">		// Now that shared cache is loaded, setup an versioned dylib overrides</div><div class="line">	#if SUPPORT_VERSIONED_PATHS</div><div class="line">		checkVersionedPaths();</div><div class="line">	#endif</div><div class="line"></div><div class="line">		//第四步，加载插入的动态库</div><div class="line">		if	( sEnv.DYLD_INSERT_LIBRARIES != NULL ) &#123;</div><div class="line">			for (const char* const* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != NULL; ++lib)</div><div class="line">				loadInsertedDylib(*lib);</div><div class="line">		&#125;</div><div class="line">		sInsertedDylibCount = sAllImages.size()-1;</div><div class="line"></div><div class="line">		//第五步，链接主程序</div><div class="line">		gLinkContext.linkingMainExecutable = true;</div><div class="line">		link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL));</div><div class="line">		sMainExecutable-&gt;setNeverUnloadRecursive();</div><div class="line">		if ( sMainExecutable-&gt;forceFlat() ) &#123;</div><div class="line">			gLinkContext.bindFlat = true;</div><div class="line">			gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//第六步，链接插入的动态库</div><div class="line">		if ( sInsertedDylibCount &gt; 0 ) &#123;</div><div class="line">			for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) &#123;</div><div class="line">				ImageLoader* image = sAllImages[i+1];</div><div class="line">				link(image, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL));</div><div class="line">				image-&gt;setNeverUnloadRecursive();</div><div class="line">			&#125;</div><div class="line">			// only INSERTED libraries can interpose</div><div class="line">			for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) &#123;</div><div class="line">				ImageLoader* image = sAllImages[i+1];</div><div class="line">				image-&gt;registerInterposing();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// &lt;rdar://problem/19315404&gt; dyld should support interposition even without DYLD_INSERT_LIBRARIES</div><div class="line">		for (int i=sInsertedDylibCount+1; i &lt; sAllImages.size(); ++i) &#123;</div><div class="line">			ImageLoader* image = sAllImages[i];</div><div class="line">			if ( image-&gt;inSharedCache() )</div><div class="line">				continue;</div><div class="line">			image-&gt;registerInterposing();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// apply interposing to initial set of images</div><div class="line">		for(int i=0; i &lt; sImageRoots.size(); ++i) &#123;</div><div class="line">			sImageRoots[i]-&gt;applyInterposing(gLinkContext);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">        //第七步，执行弱符号绑定</div><div class="line">		gLinkContext.linkingMainExecutable = false;</div><div class="line">		// &lt;rdar://problem/12186933&gt; do weak binding only after all inserted images linked</div><div class="line">		sMainExecutable-&gt;weakBind(gLinkContext);</div><div class="line"></div><div class="line">        //第八步，执行初始化方法</div><div class="line">		CRSetCrashLogMessage(&quot;dyld: launch, running initializers&quot;);</div><div class="line">	#if SUPPORT_OLD_CRT_INITIALIZATION</div><div class="line">		// Old way is to run initializers via a callback from crt1.o</div><div class="line">		if ( ! gRunInitializersOldWay )</div><div class="line">			initializeMainExecutable();</div><div class="line">	#else</div><div class="line">		// run all initializers</div><div class="line">		initializeMainExecutable();</div><div class="line">	#endif</div><div class="line"></div><div class="line">        //第九步，查找入口点并返回</div><div class="line">		result = (uintptr_t)sMainExecutable-&gt;getThreadPC();</div><div class="line">		if ( result != 0 ) &#123;</div><div class="line">			// main executable uses LC_MAIN, needs to return to glue in libdyld.dylib</div><div class="line">			if ( (gLibSystemHelpers != NULL) &amp;&amp; (gLibSystemHelpers-&gt;version &gt;= 9) )</div><div class="line">				*startGlue = (uintptr_t)gLibSystemHelpers-&gt;startGlueToCallExit;</div><div class="line">			else</div><div class="line">				halt(&quot;libdyld.dylib support not present for LC_MAIN&quot;);</div><div class="line">		&#125;</div><div class="line">		else &#123;</div><div class="line">			// main executable uses LC_UNIXTHREAD, dyld needs to let &quot;start&quot; in program set up for main()</div><div class="line">			result = (uintptr_t)sMainExecutable-&gt;getMain();</div><div class="line">			*startGlue = 0;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	catch(const char* message) &#123;</div><div class="line">		syncAllImages();</div><div class="line">		halt(message);</div><div class="line">	&#125;</div><div class="line">	catch(...) &#123;</div><div class="line">		dyld::log(&quot;dyld: launch failed\n&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	CRSetCrashLogMessage(NULL);</div><div class="line"></div><div class="line">	return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>整个方法的代码比较长，将它按功能分成九个步骤进行讲解：</p>
<h4 id="第一步，设置运行环境，处理环境变量"><a href="#第一步，设置运行环境，处理环境变量" class="headerlink" title="第一步，设置运行环境，处理环境变量"></a>第一步，设置运行环境，处理环境变量</h4><p>代码在开始时候，将传入的变量<code>mainExecutableMH</code>赋值给了<code>sMainExecutableMachHeader</code>，这是一个<code>macho_header</code>类型的变量，其结构体内容就是本章前面介绍的<code>mach_header</code>结构体，表示的是当前主程序的Mach-O头部信息，有了头部信息，加载器就可以从头开始，遍历整个Mach-O文件的信息。<br>接着执行了<code>setContext()</code>，此方法设置了全局一个链接上下文，包括一些回调函数、参数与标志设置信息，代码片断如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">static void setContext(const macho_header* mainExecutableMH, int argc, const char* argv[], const char* envp[], const char* apple[])</div><div class="line">&#123;</div><div class="line">	gLinkContext.loadLibrary			= &amp;libraryLocator;</div><div class="line">	gLinkContext.terminationRecorder	= &amp;terminationRecorder;</div><div class="line">	gLinkContext.flatExportFinder		= &amp;flatFindExportedSymbol;</div><div class="line">	gLinkContext.coalescedExportFinder	= &amp;findCoalescedExportedSymbol;</div><div class="line">	gLinkContext.getCoalescedImages		= &amp;getCoalescedImages;</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">	gLinkContext.bindingOptions			= ImageLoader::kBindingNone;</div><div class="line">	gLinkContext.argc					= argc;</div><div class="line">	gLinkContext.argv					= argv;</div><div class="line">	gLinkContext.envp					= envp;</div><div class="line">	gLinkContext.apple					= apple;</div><div class="line">	gLinkContext.progname				= (argv[0] != NULL) ? basename(argv[0]) : &quot;&quot;;</div><div class="line">	gLinkContext.programVars.mh			= mainExecutableMH;</div><div class="line">	gLinkContext.programVars.NXArgcPtr	= &amp;gLinkContext.argc;</div><div class="line">	gLinkContext.programVars.NXArgvPtr	= &amp;gLinkContext.argv;</div><div class="line">	gLinkContext.programVars.environPtr	= &amp;gLinkContext.envp;</div><div class="line">	gLinkContext.programVars.__prognamePtr=&amp;gLinkContext.progname;</div><div class="line">	gLinkContext.mainExecutable			= NULL;</div><div class="line">	gLinkContext.imageSuffix			= NULL;</div><div class="line">	gLinkContext.dynamicInterposeArray	= NULL;</div><div class="line">	gLinkContext.dynamicInterposeCount	= 0;</div><div class="line">	gLinkContext.prebindUsage			= ImageLoader::kUseAllPrebinding;</div><div class="line">#if TARGET_IPHONE_SIMULATOR</div><div class="line">	gLinkContext.sharedRegionMode		= ImageLoader::kDontUseSharedRegion;</div><div class="line">#else</div><div class="line">	gLinkContext.sharedRegionMode		= ImageLoader::kUseSharedRegion;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>设置的回调函数都是dyld本模块实现的，如<code>loadLibrary</code>方法就是本模块的<code>libraryLocator()</code>方法，负责加载动态库。<br>在设置完这些信息后，执行<code>processRestricted()</code>方法判断进程是否受限。代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">static bool processRestricted(const macho_header* mainExecutableMH, bool* ignoreEnvVars, bool* processRequiresLibraryValidation)</div><div class="line">&#123;</div><div class="line">#if TARGET_IPHONE_SIMULATOR</div><div class="line">	gLinkContext.codeSigningEnforced = true;</div><div class="line">#else</div><div class="line">    // ask kernel if code signature of program makes it restricted</div><div class="line">    uint32_t flags;</div><div class="line">	if ( csops(0, CS_OPS_STATUS, &amp;flags, sizeof(flags)) != -1 ) &#123;</div><div class="line">		if (flags &amp; CS_REQUIRE_LV)</div><div class="line">			*processRequiresLibraryValidation = true;</div><div class="line"></div><div class="line">  #if __MAC_OS_X_VERSION_MIN_REQUIRED</div><div class="line">		if ( flags &amp; CS_ENFORCEMENT ) &#123;</div><div class="line">			gLinkContext.codeSigningEnforced = true;</div><div class="line">		&#125;</div><div class="line">		if ( ((flags &amp; CS_RESTRICT) == CS_RESTRICT) &amp;&amp; (csr_check(CSR_ALLOW_TASK_FOR_PID) != 0) ) &#123;</div><div class="line">			sRestrictedReason = restrictedByEntitlements;</div><div class="line">			return true;</div><div class="line">		&#125;</div><div class="line">  #else</div><div class="line">		if ((flags &amp; CS_ENFORCEMENT) &amp;&amp; !(flags &amp; CS_GET_TASK_ALLOW)) &#123;</div><div class="line">			*ignoreEnvVars = true;</div><div class="line">		&#125;</div><div class="line">		gLinkContext.codeSigningEnforced = true;</div><div class="line">  #endif</div><div class="line">	&#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">	// all processes with setuid or setgid bit set are restricted</div><div class="line">    if ( issetugid() ) &#123;</div><div class="line">		sRestrictedReason = restrictedBySetGUid;</div><div class="line">		return true;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// &lt;rdar://problem/13158444&amp;13245742&gt; Respect __RESTRICT,__restrict section for root processes</div><div class="line">	if ( hasRestrictedSegment(mainExecutableMH) ) &#123;</div><div class="line">		// existence of __RESTRICT/__restrict section make process restricted</div><div class="line">		sRestrictedReason = restrictedBySegment;</div><div class="line">		return true;</div><div class="line">	&#125;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>进程受限会是以下三种可能：<br><code>restrictedByEntitlements</code>：在macOS系统上，在需要验证代码签名（<code>Gatekeeper</code>开启）的情况下，且<code>csr_check(CSR_ALLOW_TASK_FOR_PID)</code>返回为真（表示Rootless开启了<code>TASK_FOR_PID</code>标志）时，进程才不会受限，在macOS版本10.12系统上，默认<code>Gatekeeper</code>是开启的，并且<code>Rootless</code>是关闭了<code>CSR_ALLOW_TASK_FOR_PID</code>标志位的，这意味着，默认情况下，系统上运行的进程是受限的。<br><code>restrictedBySetGUid</code>：当进程的setuid与setgid位被设置时，进程会被设置成受限。这样做是出于安全的考虑，受限后的进程无法访问<code>DYLD_</code>开头的环境变量，一种典型的系统攻击就是针对这种情况而发生的，在macOS版本10.10系统上，一个由<code>DYLD_PRINT_TO_FILE</code>环境变量引发的系统本地提权漏洞，就是通过向<code>DYLD_PRINT_TO_FILE</code>环境变量传入拥有SUID权限的受限文件，而系统没做安全检测，而这些文件是直接有向系统创建与写入文件权限的。关于漏洞的具体细节可以参看：<a href="https://www.sektioneins.de/en/blog/15-07-07-dyld_print_to_file_lpe.html" target="_blank" rel="external">https://www.sektioneins.de/en/blog/15-07-07-dyld_print_to_file_lpe.html</a><br><code>restrictedBySegment</code>：段名受限。当Mach-O包含一个<code>__RESTRICT/__restrict</code>段时，进程会被设置成受限。</p>
<p>在进程受限后，执行了以下三个方法：<br><code>checkLoadCommandEnvironmentVariables()</code>:遍历Mach-O中所有的<code>LC_DYLD_ENVIRONMENT</code>加载命令，然后调用<code>processDyldEnvironmentVariable()</code>对不同的环境变量做相应的处理。<br><code>pruneEnvironmentVariables()</code>:删除进程的<code>LD_LIBRARY_PATH</code>与所有以DYLD_开头的环境变量，这样以后创建的子进程就不包含这些环境变量了。<br><code>setContext()</code>:重新设置链接上下文。这一步执行的主要目的是由于环境变量发生变化了，需要更新进程的<code>envp</code>与<code>apple</code>参数。</p>
<h4 id="第二步，初始化主程序"><a href="#第二步，初始化主程序" class="headerlink" title="第二步，初始化主程序"></a>第二步，初始化主程序</h4><p>这一步主要执行了<code>instantiateFromLoadedImage()</code>。它的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">static ImageLoader* instantiateFromLoadedImage(const macho_header* mh, uintptr_t slide, const char* path)</div><div class="line">&#123;</div><div class="line">	// try mach-o loader</div><div class="line">	if ( isCompatibleMachO((const uint8_t*)mh, path) ) &#123;</div><div class="line">		ImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext);</div><div class="line">		addImage(image);</div><div class="line">		return image;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	throw &quot;main executable not a known format&quot;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>isCompatibleMachO()</code>主要检查Mach-O的头部的<code>cputype</code>与<code>cpusubtype</code>来判断程序与当前的系统是否兼容。如果兼容接下来就调用<code>instantiateMainExecutable()</code>实例化主程序，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">ImageLoader* ImageLoaderMachO::instantiateMainExecutable(const macho_header* mh, uintptr_t slide, const char* path, const LinkContext&amp; context)</div><div class="line">&#123;</div><div class="line">	//dyld::log(&quot;ImageLoader=%ld, ImageLoaderMachO=%ld, ImageLoaderMachOClassic=%ld, ImageLoaderMachOCompressed=%ld\n&quot;,</div><div class="line">	//	sizeof(ImageLoader), sizeof(ImageLoaderMachO), sizeof(ImageLoaderMachOClassic), sizeof(ImageLoaderMachOCompressed));</div><div class="line">	bool compressed;</div><div class="line">	unsigned int segCount;</div><div class="line">	unsigned int libCount;</div><div class="line">	const linkedit_data_command* codeSigCmd;</div><div class="line">	const encryption_info_command* encryptCmd;</div><div class="line">	sniffLoadCommands(mh, path, false, &amp;compressed, &amp;segCount, &amp;libCount, context, &amp;codeSigCmd, &amp;encryptCmd);</div><div class="line">	// instantiate concrete class based on content of load commands</div><div class="line">	if ( compressed )</div><div class="line">		return ImageLoaderMachOCompressed::instantiateMainExecutable(mh, slide, path, segCount, libCount, context);</div><div class="line">	else</div><div class="line">#if SUPPORT_CLASSIC_MACHO</div><div class="line">		return ImageLoaderMachOClassic::instantiateMainExecutable(mh, slide, path, segCount, libCount, context);</div><div class="line">#else</div><div class="line">		throw &quot;missing LC_DYLD_INFO load command&quot;;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>sniffLoadCommands()</code>主要获取了加载命令中的如下信息：<br><code>compressed</code>：判断Mach-O的<code>Compressed</code>还是<code>Classic</code>类型。判断的依据是Mach-O是否包含<code>LC_DYLD_INFO</code>或<code>LC_DYLD_INFO_ONLY</code>加载命令。这2个加载命令记录了Mach-O的动态库加载信息，使用结构体<code>dyld_info_command</code>表示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">struct dyld_info_command &#123;</div><div class="line">   uint32_t   cmd;		/* LC_DYLD_INFO or LC_DYLD_INFO_ONLY */</div><div class="line">   uint32_t   cmdsize;		/* sizeof(struct dyld_info_command) */</div><div class="line">   uint32_t   rebase_off;	/* file offset to rebase info  */</div><div class="line">   uint32_t   rebase_size;	/* size of rebase info   */</div><div class="line">   uint32_t   bind_off;	/* file offset to binding info   */</div><div class="line">   uint32_t   bind_size;	/* size of binding info  */</div><div class="line">   uint32_t   weak_bind_off;	/* file offset to weak binding info   */</div><div class="line">   uint32_t   weak_bind_size;  /* size of weak binding info  */</div><div class="line">   uint32_t   lazy_bind_off;	/* file offset to lazy binding info */</div><div class="line">   uint32_t   lazy_bind_size;  /* size of lazy binding infs */</div><div class="line">   uint32_t   export_off;	/* file offset to lazy binding info */</div><div class="line">   uint32_t   export_size;	/* size of lazy binding infs */</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><code>rebase_off</code>与大小<code>rebase_size</code>存储了rebase（重设基址）相关信息，当Mach-O加载到内存中的地址不是指定的首选地址时，就需要对当前的映像数据进行rebase（重设基址）。<br><code>bind_off</code>与<code>bind_size</code>存储了进程的符号绑定信息，当进程启动时必须绑定这些符号，典型的有<code>dyld_stub_binder</code>，该符号被dyld用来做迟绑定加载符号，一般动态库都包含该符号。<br><code>weak_bind_off</code>与<code>weak_bind_size</code>存储了进程的弱绑定符号信息。弱符号主要用于面向对旬语言中的符号重载，典型的有c++中使用new创建对象，默认情况下会绑定ibstdc++.dylib，如果检测到某个映像使用弱符号引用重载了<code>new</code>符号，dyld则会重新绑定该符号并调用重载的版本。<br><code>lazy_bind_off</code>与<code>lazy_bind_size</code>存储了进程的延迟绑定符号信息。有些符号在进程启动时不需要马上解析，它们会在第一次调用时被解析，这类符号叫延迟绑定符号（Lazy Symbol）。<br><code>export_off</code>与<code>export_size</code>存储了进程的导出符号绑定信息。导出符号可以被外部的Mach-O访问，通常动态库会导出一个或多个符号供外部使用，而可执行程序由导出<code>_main</code>与<code>_mh_execute_header</code>符号供dyld使用。</p>
<p><code>segCount</code>：段的数量。<code>sniffLoadCommands()</code>通过遍历所有的<code>LC_SEGMENT_COMMAND</code>加载命令来获取段的数量。</p>
<p><code>libCount</code>：需要加载的动态库的数量。Mach-O中包含的每一条<code>LC_LOAD_DYLIB</code>、<code>LC_LOAD_WEAK_DYLIB</code>、<code>LC_REEXPORT_DYLIB</code>、<code>LC_LOAD_UPWARD_DYLIB</code>加载命令，都表示需要加载一个动态库。</p>
<p><code>codeSigCmd</code>：通过解析<code>LC_CODE_SIGNATURE</code>来获取代码签名的加载命令。</p>
<p><code>encryptCmd</code>：通过<code>LC_ENCRYPTION_INFO</code>与<code>LC_ENCRYPTION_INFO_64</code>来获取段加密信息。</p>
<p>获取<code>compressed</code>后，根据Mach-O是否<code>compressed</code>来分别调用<code>ImageLoaderMachOCompressed::instantiateMainExecutable()</code>与<code>ImageLoaderMachOClassic::instantiateMainExecutable()</code>。<code>ImageLoaderMachOCompressed::instantiateMainExecutable()</code>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">// create image for main executable</div><div class="line">ImageLoaderMachOCompressed* ImageLoaderMachOCompressed::instantiateMainExecutable(const macho_header* mh, uintptr_t slide, const char* path,</div><div class="line">																		unsigned int segCount, unsigned int libCount, const LinkContext&amp; context)</div><div class="line">&#123;</div><div class="line">	ImageLoaderMachOCompressed* image = ImageLoaderMachOCompressed::instantiateStart(mh, path, segCount, libCount);</div><div class="line"></div><div class="line">	// set slide for PIE programs</div><div class="line">	image-&gt;setSlide(slide);</div><div class="line"></div><div class="line">	// for PIE record end of program, to know where to start loading dylibs</div><div class="line">	if ( slide != 0 )</div><div class="line">		fgNextPIEDylibAddress = (uintptr_t)image-&gt;getEnd();</div><div class="line"></div><div class="line">	image-&gt;disableCoverageCheck();</div><div class="line">	image-&gt;instantiateFinish(context);</div><div class="line">	image-&gt;setMapped(context);</div><div class="line"></div><div class="line">	if ( context.verboseMapping ) &#123;</div><div class="line">		dyld::log(&quot;dyld: Main executable mapped %s\n&quot;, path);</div><div class="line">		for(unsigned int i=0, e=image-&gt;segmentCount(); i &lt; e; ++i) &#123;</div><div class="line">			const char* name = image-&gt;segName(i);</div><div class="line">			if ( (strcmp(name, &quot;__PAGEZERO&quot;) == 0) || (strcmp(name, &quot;__UNIXSTACK&quot;) == 0)  )</div><div class="line">				dyld::log(&quot;%18s at 0x%08lX-&gt;0x%08lX\n&quot;, name, image-&gt;segPreferredLoadAddress(i), image-&gt;segPreferredLoadAddress(i)+image-&gt;segSize(i));</div><div class="line">			else</div><div class="line">				dyld::log(&quot;%18s at 0x%08lX-&gt;0x%08lX\n&quot;, name, image-&gt;segActualLoadAddress(i), image-&gt;segActualEndAddress(i));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	return image;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>ImageLoaderMachOCompressed::instantiateStart()</code>使用主程序Mach-O信息构造了一个<code>ImageLoaderMachOCompressed</code>对象。<code>disableCoverageCheck()</code>禁用覆盖率检查。<code>instantiateFinish()</code>调用<code>parseLoadCmds()</code>解析其它所有的加载命令，后者会填充完<code>ImageLoaderMachOCompressed</code>的一些保护成员信息，最后调用<code>setDyldInfo()</code>设置动态库链接信息，然后调用<code>setSymbolTableInfo()</code>设置符号表信息。</p>
<p><code>instantiateFromLoadedImage()</code>调用完了<code>ImageLoaderMachO::instantiateMainExecutable()</code>后，接着调用<code>addImage()</code>，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">static void addImage(ImageLoader* image)</div><div class="line">&#123;</div><div class="line">	// add to master list</div><div class="line">    allImagesLock();</div><div class="line">        sAllImages.push_back(image);</div><div class="line">    allImagesUnlock();</div><div class="line"></div><div class="line">	// update mapped ranges</div><div class="line">	uintptr_t lastSegStart = 0;</div><div class="line">	uintptr_t lastSegEnd = 0;</div><div class="line">	for(unsigned int i=0, e=image-&gt;segmentCount(); i &lt; e; ++i) &#123;</div><div class="line">		if ( image-&gt;segUnaccessible(i) )</div><div class="line">			continue;</div><div class="line">		uintptr_t start = image-&gt;segActualLoadAddress(i);</div><div class="line">		uintptr_t end = image-&gt;segActualEndAddress(i);</div><div class="line">		if ( start == lastSegEnd ) &#123;</div><div class="line">			// two segments are contiguous, just record combined segments</div><div class="line">			lastSegEnd = end;</div><div class="line">		&#125;</div><div class="line">		else &#123;</div><div class="line">			// non-contiguous segments, record last (if any)</div><div class="line">			if ( lastSegEnd != 0 )</div><div class="line">				addMappedRange(image, lastSegStart, lastSegEnd);</div><div class="line">			lastSegStart = start;</div><div class="line">			lastSegEnd = end;</div><div class="line">		&#125;		</div><div class="line">	&#125;</div><div class="line">	if ( lastSegEnd != 0 )</div><div class="line">		addMappedRange(image, lastSegStart, lastSegEnd);</div><div class="line"></div><div class="line"></div><div class="line">	if ( sEnv.DYLD_PRINT_LIBRARIES || (sEnv.DYLD_PRINT_LIBRARIES_POST_LAUNCH &amp;&amp; (sMainExecutable!=NULL) &amp;&amp; sMainExecutable-&gt;isLinked()) ) &#123;</div><div class="line">		dyld::log(&quot;dyld: loaded: %s\n&quot;, image-&gt;getPath());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这段代码将实例化好的主程序添加到全局主列表<code>sAllImages</code>中，最后调用<code>addMappedRange()</code>申请内存，更新主程序映像映射的内存区。做完这些工作，第二步初始化主程序就算完成了。</p>
<h4 id="第三步，加载共享缓存"><a href="#第三步，加载共享缓存" class="headerlink" title="第三步，加载共享缓存"></a>第三步，加载共享缓存</h4><p>这一步主要执行<code>mapSharedCache()</code>来映射共享缓存。该函数先通过<code>_shared_region_check_np()</code>来检查缓存是否已经映射到了共享区域了，如果已经映射了，就更新缓存的<code>slide</code>与<code>UUID</code>，然后返回。反之，判断系统是否处于安全启动模式（safe-boot mode）下，如果是就删除缓存文件并返回，正常启动的情况下，接下来调用<code>openSharedCacheFile()</code>打开缓存文件，该函数在<code>sSharedCacheDir</code>路径下，打开与系统当前cpu架构匹配的缓存文件，也就是/var/db/dyld/dyld_shared_cache_x86_64h，接着读取缓存文件的前8192字节，解析缓存头<code>dyld_cache_header</code>的信息，将解析好的缓存信息存入<code>mappings</code>变量，最后调用<code>_shared_region_map_and_slide_np()</code>完成真正的映射工作。部分代码片断如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line">static void mapSharedCache()</div><div class="line">&#123;</div><div class="line">	uint64_t cacheBaseAddress = 0;</div><div class="line">	if ( _shared_region_check_np(&amp;cacheBaseAddress) == 0 ) &#123;</div><div class="line">		sSharedCache = (dyld_cache_header*)cacheBaseAddress;</div><div class="line">#if __x86_64__</div><div class="line">		const char* magic = (sHaswell ? ARCH_CACHE_MAGIC_H : ARCH_CACHE_MAGIC);</div><div class="line">#else</div><div class="line">		const char* magic = ARCH_CACHE_MAGIC;</div><div class="line">#endif</div><div class="line">		if ( strcmp(sSharedCache-&gt;magic, magic) != 0 ) &#123;</div><div class="line">			sSharedCache = NULL;</div><div class="line">			if ( gLinkContext.verboseMapping ) &#123;</div><div class="line">				dyld::log(&quot;dyld: existing shared cached in memory is not compatible\n&quot;);</div><div class="line">				return;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		const dyld_cache_header* header = sSharedCache;</div><div class="line">		......</div><div class="line">		// if cache has a uuid, copy it</div><div class="line">		if ( header-&gt;mappingOffset &gt;= 0x68 ) &#123;</div><div class="line">			memcpy(dyld::gProcessInfo-&gt;sharedCacheUUID, header-&gt;uuid, 16);</div><div class="line">		&#125;</div><div class="line">		......</div><div class="line">	&#125;</div><div class="line">	else &#123;</div><div class="line">#if __i386__ || __x86_64__</div><div class="line">		uint32_t	safeBootValue = 0;</div><div class="line">		size_t		safeBootValueSize = sizeof(safeBootValue);</div><div class="line">		if ( (sysctlbyname(&quot;kern.safeboot&quot;, &amp;safeBootValue, &amp;safeBootValueSize, NULL, 0) == 0) &amp;&amp; (safeBootValue != 0) ) &#123;</div><div class="line">			struct stat dyldCacheStatInfo;</div><div class="line">			if ( my_stat(MACOSX_DYLD_SHARED_CACHE_DIR DYLD_SHARED_CACHE_BASE_NAME ARCH_NAME, &amp;dyldCacheStatInfo) == 0 ) &#123;</div><div class="line">				struct timeval bootTimeValue;</div><div class="line">				size_t bootTimeValueSize = sizeof(bootTimeValue);</div><div class="line">				if ( (sysctlbyname(&quot;kern.boottime&quot;, &amp;bootTimeValue, &amp;bootTimeValueSize, NULL, 0) == 0) &amp;&amp; (bootTimeValue.tv_sec != 0) ) &#123;</div><div class="line">					if ( dyldCacheStatInfo.st_mtime &lt; bootTimeValue.tv_sec ) &#123;</div><div class="line">						::unlink(MACOSX_DYLD_SHARED_CACHE_DIR DYLD_SHARED_CACHE_BASE_NAME ARCH_NAME);</div><div class="line">						gLinkContext.sharedRegionMode = ImageLoader::kDontUseSharedRegion;</div><div class="line">						return;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">#endif</div><div class="line">		// map in shared cache to shared region</div><div class="line">		int fd = openSharedCacheFile();</div><div class="line">		if ( fd != -1 ) &#123;</div><div class="line">			uint8_t firstPages[8192];</div><div class="line">			if ( ::read(fd, firstPages, 8192) == 8192 ) &#123;</div><div class="line">				dyld_cache_header* header = (dyld_cache_header*)firstPages;</div><div class="line">		#if __x86_64__</div><div class="line">				const char* magic = (sHaswell ? ARCH_CACHE_MAGIC_H : ARCH_CACHE_MAGIC);</div><div class="line">		#else</div><div class="line">				const char* magic = ARCH_CACHE_MAGIC;</div><div class="line">		#endif</div><div class="line">				if ( strcmp(header-&gt;magic, magic) == 0 ) &#123;</div><div class="line">					const dyld_cache_mapping_info* const fileMappingsStart = (dyld_cache_mapping_info*)&amp;firstPages[header-&gt;mappingOffset];</div><div class="line">					const dyld_cache_mapping_info* const fileMappingsEnd = &amp;fileMappingsStart[header-&gt;mappingCount];</div><div class="line">					shared_file_mapping_np	mappings[header-&gt;mappingCount+1]; // add room for code-sig</div><div class="line"></div><div class="line">					......</div><div class="line"></div><div class="line">						if (_shared_region_map_and_slide_np(fd, mappingCount, mappings, codeSignatureMappingIndex, cacheSlide, slideInfo, slideInfoSize) == 0) &#123;</div><div class="line">							sSharedCache = (dyld_cache_header*)mappings[0].sfm_address;</div><div class="line">							sSharedCacheSlide = cacheSlide;</div><div class="line">							dyld::gProcessInfo-&gt;sharedCacheSlide = cacheSlide;</div><div class="line">							......</div><div class="line">						&#125;</div><div class="line">						else &#123;</div><div class="line">#if __IPHONE_OS_VERSION_MIN_REQUIRED</div><div class="line">							throw &quot;dyld shared cache could not be mapped&quot;;</div><div class="line">#endif</div><div class="line">							if ( gLinkContext.verboseMapping )</div><div class="line">								dyld::log(&quot;dyld: shared cached file could not be mapped\n&quot;);</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				else &#123;</div><div class="line">					if ( gLinkContext.verboseMapping )</div><div class="line">						dyld::log(&quot;dyld: shared cached file is invalid\n&quot;);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			else &#123;</div><div class="line">				if ( gLinkContext.verboseMapping )</div><div class="line">					dyld::log(&quot;dyld: shared cached file cannot be read\n&quot;);</div><div class="line">			&#125;</div><div class="line">			close(fd);</div><div class="line">		&#125;</div><div class="line">		else &#123;</div><div class="line">			if ( gLinkContext.verboseMapping )</div><div class="line">				dyld::log(&quot;dyld: shared cached file cannot be opened\n&quot;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	......</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>共享缓存加载完毕后，接着进行动态库的版本化重载，这主要通过函数checkVersionedPaths()完成。该函数读取<code>DYLD_VERSIONED_LIBRARY_PATH</code>与<code>DYLD_VERSIONED_FRAMEWORK_PATH</code>环境变量，将指定版本的库比当前加载的库的版本做比较，如果当前的库版本更高的话，就使用新版本的库来替换掉旧版本的。</p>
<h4 id="第四步，加载插入的动态库"><a href="#第四步，加载插入的动态库" class="headerlink" title="第四步，加载插入的动态库"></a>第四步，加载插入的动态库</h4><p>这一步循环遍历<code>DYLD_INSERT_LIBRARIES</code>环境变量中指定的动态库列表，并调用<code>loadInsertedDylib()</code>将其加载。该函数调用<code>load()</code>完成加载工作。<code>load()</code>会调用<code>loadPhase0()</code>尝试从文件加载，<code>loadPhase0()</code>会向下调用下一层phase来查找动态库的路径，直到<code>loadPhase6()</code>，查找的顺序为<code>DYLD_ROOT_PATH</code>-&gt;<code>LD_LIBRARY_PATH</code>-&gt;<code>DYLD_FRAMEWORK_PATH</code>-&gt;原始路径-&gt;<code>DYLD_FALLBACK_LIBRARY_PATH</code>，找到后调用<code>ImageLoaderMachO::instantiateFromFile()</code>来实例化一个<code>ImageLoader</code>，之后调用<code>checkandAddImage()</code>验证映像并将其加入到全局映像列表中。如果<code>loadPhase0()</code>返回为空，表示在路径中没有找到动态库，就尝试从共享缓存中查找，找到就调用<code>ImageLoaderMachO::instantiateFromCache()</code>从缓存中加载，否则就抛出没找到映像的异常。部分代码片断如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">ImageLoader* load(const char* path, const LoadContext&amp; context)</div><div class="line">&#123;</div><div class="line">	......</div><div class="line">	if ( context.useSearchPaths &amp;&amp; ( gLinkContext.imageSuffix != NULL) ) &#123;</div><div class="line">		if ( realpath(path, realPath) != NULL )</div><div class="line">			path = realPath;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ImageLoader* image = loadPhase0(path, orgPath, context, NULL);</div><div class="line">	if ( image != NULL ) &#123;</div><div class="line">		CRSetCrashLogMessage2(NULL);</div><div class="line">		return image;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	......</div><div class="line">	image = loadPhase0(path, orgPath, context, &amp;exceptions);</div><div class="line">#if __IPHONE_OS_VERSION_MIN_REQUIRED &amp;&amp; DYLD_SHARED_CACHE_SUPPORT &amp;&amp; !TARGET_IPHONE_SIMULATOR</div><div class="line">	// &lt;rdar://problem/16704628&gt; support symlinks on disk to a path in dyld shared cache</div><div class="line">	if ( (image == NULL) &amp;&amp; cacheablePath(path) &amp;&amp; !context.dontLoad ) &#123;</div><div class="line">		......</div><div class="line">		if ( (myerr == ENOENT) || (myerr == 0) )</div><div class="line">		&#123;</div><div class="line">			const macho_header* mhInCache;</div><div class="line">			const char*			pathInCache;</div><div class="line">			long				slideInCache;</div><div class="line">			if ( findInSharedCacheImage(resolvedPath, false, NULL, &amp;mhInCache, &amp;pathInCache, &amp;slideInCache) ) &#123;</div><div class="line">				struct stat stat_buf;</div><div class="line">				bzero(&amp;stat_buf, sizeof(stat_buf));</div><div class="line">				try &#123;</div><div class="line">					image = ImageLoaderMachO::instantiateFromCache(mhInCache, pathInCache, slideInCache, stat_buf, gLinkContext);</div><div class="line">					image = checkandAddImage(image, context);</div><div class="line">				&#125;</div><div class="line">				catch (...) &#123;</div><div class="line">					image = NULL;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">#endif</div><div class="line">    ......</div><div class="line">	else &#123;</div><div class="line">		const char* msgStart = &quot;no suitable image found.  Did find:&quot;;</div><div class="line">		......</div><div class="line">		throw (const char*)fullMsg;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="第五步，链接主程序"><a href="#第五步，链接主程序" class="headerlink" title="第五步，链接主程序"></a>第五步，链接主程序</h4><p>这一步执行<code>link()</code>完成主程序的链接操作。该函数调用了<code>ImageLoader</code>自身的<code>link()</code>函数，主要的目的是将实例化的主程序的动态数据进行修正，达到让进程可用的目的，典型的就是主程序中的符号表修正操作，它的代码片断如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">void ImageLoader::link(const LinkContext&amp; context, bool forceLazysBound, bool preflightOnly, bool neverUnload, const RPathChain&amp; loaderRPaths)</div><div class="line">&#123;</div><div class="line">	......</div><div class="line">	this-&gt;recursiveLoadLibraries(context, preflightOnly, loaderRPaths);</div><div class="line"></div><div class="line">	......</div><div class="line"></div><div class="line">	context.clearAllDepths();</div><div class="line">	this-&gt;recursiveUpdateDepth(context.imageCount());</div><div class="line"></div><div class="line"> 	this-&gt;recursiveRebase(context);</div><div class="line"></div><div class="line">	......</div><div class="line"></div><div class="line"> 	this-&gt;recursiveBind(context, forceLazysBound, neverUnload);</div><div class="line"></div><div class="line">	if ( !context.linkingMainExecutable )</div><div class="line">		this-&gt;weakBind(context);	//现在是链接主程序，这里现在不会执行</div><div class="line"></div><div class="line">	......</div><div class="line"></div><div class="line">	std::vector&lt;DOFInfo&gt; dofs;</div><div class="line">	this-&gt;recursiveGetDOFSections(context, dofs);</div><div class="line">	context.registerDOFs(dofs);</div><div class="line"></div><div class="line">	......</div><div class="line"></div><div class="line">	if ( !context.linkingMainExecutable &amp;&amp; (fgInterposingTuples.size() != 0) ) &#123;</div><div class="line">		this-&gt;recursiveApplyInterposing(context);	//现在是链接主程序，这里现在不会执行</div><div class="line">	&#125;</div><div class="line">	......</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>recursiveLoadLibraries()</code>采用递归的方式来加载程序依赖的动态库，加载的方法是调用<code>context</code>的<code>loadLibrary</code>指针方法，该方法在前面看到过，是<code>setContext()</code>设置的<code>libraryLocator()</code>，该函数只是调用了<code>load()</code>来完成加载，<code>load()</code>加载动态库的过程在上一步已经分析过了。</p>
<p>接着调用<code>recursiveUpdateDepth()</code>对映像及其依赖库按列表方式进行排序。<code>recursiveRebase()</code>则对映像完成递归rebase操作，该函数只是调用了虚函数<code>doRebase()</code>，<code>doRebase()</code>被<code>ImageLoaderMachO</code>重载，实际只是将代码段设置成可写后调用了<code>rebase()</code>，在<code>ImageLoaderMachOCompressed</code>中，该函数读取映像动态链接信息的<code>rebase_off</code>与<code>rebase_size</code>来确定需要rebase的数据偏移与大小，然后挨个修正它们的地址信息。</p>
<p><code>recursiveBind()</code>完成递归绑定符号表的操作。此处的符号表针对的是非延迟加载的符号表，它的核心是调用了<code>doBind()</code>，在<code>ImageLoaderMachOCompressed</code>中，该函数读取映像动态链接信息的<code>bind_off</code>与<code>bind_size</code>来确定需要绑定的数据偏移与大小，然后挨个对它们进行绑定，绑定操作具体使用<code>bindAt()</code>函数，它主要通过调用<code>resolve()</code>解析完符号表后，调用<code>bindLocation()</code>完成最终的绑定操作，需要绑定的符号信息有三种：<br><code>BIND_TYPE_POINTER</code>：需要绑定的是一个指针。直接将计算好的新值屿值即可。<br><code>BIND_TYPE_TEXT_ABSOLUTE32</code>：一个32位的值。取计算的值的低32位赋值过去。<br><code>BIND_TYPE_TEXT_PCREL32</code>：重定位符号。需要使用新值减掉需要修正的地址值来计算出重定位值。</p>
<p><code>recursiveGetDOFSections</code>()与<code>registerDOFs()</code>主要注册程序的DOF节区，供<code>dtrace</code>使用。</p>
<h4 id="第六步，链接插入的动态库"><a href="#第六步，链接插入的动态库" class="headerlink" title="第六步，链接插入的动态库"></a>第六步，链接插入的动态库</h4><p>链接插入的动态库与链接主程序一样，都是使用的<code>link()</code>,插入的动态库列表是前面调用<code>addImage()</code>保存到<code>sAllImages</code>中的，之后，循环获取每一个动态库的<code>ImageLoader</code>，调用<code>link()</code>对其进行链接，注意：<code>sAllImages</code>中保存的第一项是主程序的映像。接下来调用每个映像的<code>registerInterposing()</code>方法来注册动态库插入与调用<code>applyInterposing()</code>应用插入操作。<code>registerInterposing()</code>查找<code>__DATA</code>段的<code>__interpose</code>节区，找到需要应用插入操作（也可以叫作符号地址替换）的数据，然后做一些检查后，将要替换的符号与被替换的符号信息存入<code>fgInterposingTuples</code>列表中，供以后具体符号替换时查询。<code>applyInterposing()</code>调用了虚方法<code>doInterpose()</code>来做符号替换操作，在<code>ImageLoaderMachOCompressed</code>中实际是调用了<code>eachBind()</code>与<code>eachLazyBind()</code>分别对常规的符号与延迟加载的符号进行应用插入操作，具体使用的是<code>interposeAt()</code>，该方法调用<code>interposedAddress()</code>在<code>fgInterposingTuples</code>中查找要替换的符号地址，找到后然后进行最终的符号地址替换。</p>
<h4 id="第七步，执行弱符号绑定"><a href="#第七步，执行弱符号绑定" class="headerlink" title="第七步，执行弱符号绑定"></a>第七步，执行弱符号绑定</h4><p><code>weakBind()</code>函数执行弱符号绑定。首先通过调用<code>context</code>的<code>getCoalescedImages()</code>将<code>sAllImages</code>中所有含有弱符号的映像合并成一个列表，合并完后调用<code>initializeCoalIterator()</code>对映像进行排序，排序完成后调用<code>incrementCoalIterator()</code>收集需要进行绑定的弱符号，后者是一个虚函数，在<code>ImageLoaderMachOCompressed</code>中，该函数读取映像动态链接信息的<code>weak_bind_off</code>与<code>weak_bind_size</code>来确定弱符号的数据偏移与大小，然后挨个计算它们的地址信息。之后调用<code>getAddressCoalIterator()</code>，按照映像的加载顺序在导出表中查找符号的地址，找到后调用<code>updateUsesCoalIterator()</code>执行最终的绑定操作，执行绑定的是<code>bindLocation()</code>，前面有讲过，此处不再赘述。</p>
<h4 id="第八步，执行初始化方法"><a href="#第八步，执行初始化方法" class="headerlink" title="第八步，执行初始化方法"></a>第八步，执行初始化方法</h4><p>执行初始化的方法是<code>initializeMainExecutable()</code>。该函数主要执行<code>runInitializers()</code>，后者调用了<code>ImageLoader</code>的<code>runInitializers()</code>方法，最终迭代执行了<code>ImageLoaderMachO</code>的<code>doInitialization()</code>方法，后者主要调用<code>doImageInit()</code>与<code>doModInitFunctions()</code>执行映像与模块中设置为init的函数与静态初始化方法，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">bool ImageLoaderMachO::doInitialization(const LinkContext&amp; context)</div><div class="line">&#123;</div><div class="line">	CRSetCrashLogMessage2(this-&gt;getPath());</div><div class="line"></div><div class="line">	doImageInit(context);</div><div class="line">	doModInitFunctions(context);</div><div class="line"></div><div class="line">	CRSetCrashLogMessage2(NULL);</div><div class="line"></div><div class="line">	return (fHasDashInit || fHasInitializers);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="第九步，查找入口点并返回"><a href="#第九步，查找入口点并返回" class="headerlink" title="第九步，查找入口点并返回"></a>第九步，查找入口点并返回</h4><p>这一步调用主程序映像的<code>getThreadPC()</code>函数来查找主程序的<code>LC_MAIN</code>加载命令获取程序的入口点，没找到就调用<code>getMain()</code>到<code>LC_UNIXTHREAD</code>加载命令中去找，找到后就跳到入口点指定的地址并返回了。</p>
<p>到这里，dyld整个加载动态库的过程就算完成了。</p>
<p>另外再讨论下延迟符号加载的技术细节。在所有拥有延迟加载符号的Mach-O文件里，它的符号表中一定有一个<code>dyld_stub_helper</code>符号，它是延迟符号加载的关键！延迟绑定符号的修正工作就是由它完成的。绑定符号信息可以使用<code>XCode</code>提供的命令行工具<code>dyldinfo</code>来查看，执行以下命令可以查看<code>python</code>的绑定信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">xcrun dyldinfo -bind /usr/bin/python</div><div class="line">for arch i386:</div><div class="line">bind information:</div><div class="line">segment section          address        type    addend dylib            symbol</div><div class="line">__DATA  __cfstring       0x000040F0    pointer      0 CoreFoundation   ___CFConstantStringClassReference</div><div class="line">__DATA  __cfstring       0x00004100    pointer      0 CoreFoundation   ___CFConstantStringClassReference</div><div class="line">__DATA  __nl_symbol_ptr  0x00004010    pointer      0 CoreFoundation   _kCFAllocatorNull</div><div class="line">__DATA  __nl_symbol_ptr  0x00004008    pointer      0 libSystem        ___stack_chk_guard</div><div class="line">__DATA  __nl_symbol_ptr  0x0000400C    pointer      0 libSystem        _environ</div><div class="line">__DATA  __nl_symbol_ptr  0x00004000    pointer      0 libSystem        dyld_stub_binder</div><div class="line">bind information:</div><div class="line">segment section          address        type    addend dylib            symbol</div><div class="line">__DATA  __cfstring       0x1000031D8    pointer      0 CoreFoundation   ___CFConstantStringClassReference</div><div class="line">__DATA  __cfstring       0x1000031F8    pointer      0 CoreFoundation   ___CFConstantStringClassReference</div><div class="line">__DATA  __got            0x100003010    pointer      0 CoreFoundation   _kCFAllocatorNull</div><div class="line">__DATA  __got            0x100003000    pointer      0 libSystem        ___stack_chk_guard</div><div class="line">__DATA  __got            0x100003008    pointer      0 libSystem        _environ</div><div class="line">__DATA  __nl_symbol_ptr  0x100003018    pointer      0 libSystem        dyld_stub_binder</div></pre></td></tr></table></figure></p>
<p>所有的延迟绑定符号都存储在<code>_TEXT</code>段的<code>stubs</code>节区（桩节区），编译器在生成代码时创建的符号调用就生成在此节区中，该节区被称为“桩”节区，桩只是一小段临时使用的指令，在<code>stubs</code>中只是一条<code>jmp</code>跳转指令，跳转的地址位于<code>__DATA</code>段<code>__la_symbol_ptr</code>节区中，指向的是一段代码，类似于如下的语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">push xxx</div><div class="line">jmp yyy</div></pre></td></tr></table></figure></p>
<p>其中xxx是符号在动态链接信息中延迟绑定符号数据的偏移值，yyy则是跳转到<code>_TEXT</code>段的<code>stub_helper</code>节区头部，此处的代码通常为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">lea        r11, qword [ds:zzz]</div><div class="line">push       r11</div><div class="line">jmp        qword [ds:imp___nl_symbol_ptr_dyld_stub_binder]</div></pre></td></tr></table></figure></p>
<p><code>jmp</code>跳转的地址是<code>__DATA</code>段中<code>__nl_symbol_ptr</code>节区，指向的是符号<code>dyld_stub_binder()</code>，该函数由dyld导出，实现位于dyld源码的“dyld_stub_binder.s”文件中，它调用<code>dyld::fastBindLazySymbol()</code>来绑定延迟加载的符号，后者是一个虚函数，实际调用<code>ImageLoaderMachOCompressed</code>的<code>doBindFastLazySymbol()</code>，后者调用<code>bindAt()</code>解析并返回正确的符号地址，<code>dyld_stub_binder()</code>在最后跳转到符号地址去执行。这一步完成后，<code>__DATA</code>段<code>__la_symbol_ptr</code>节区中存储的符号地址就是修正后的地址，下一次调用该符号时，就直接跳转到真正的符号地址去执行，而不用<code>dyld_stub_binder()</code>来重新解析该符号了，</p>

      
    </div>
  	
		<! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &uarr;<br>
		   您的支持是作者最大的动力
        </span>
        <br>
      </div>  
	<div id="donate_guide" class="donate_bar center hidden" >
		<!-- 支付宝打赏图案 -->
		<! -- <img src="/images/alipay.png" alt="支付宝打赏">  -->
		<!-- 微信打赏图案 -->
		<img src="/images/wxpay.png" alt="微信打赏">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</div>

  	
    <footer class="article-footer">
      <a data-url="https://feicong.github.io/2017/01/14/dylib/" data-id="cixwyauuc0005q9vj42vhgsjh" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/macOS软件安全/">macOS软件安全</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/01/13/macho/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ouder</strong>
      <div class="article-nav-title">Mach-O文件格式</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-dylib" data-title="dylib动态库加载过程分析" data-url="https://feicong.github.io/2017/01/14/dylib/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'feicong'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>
  
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Labels</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/macOS软件安全/">macOS软件安全</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/macOS软件安全/" style="font-size: 10px;">macOS软件安全</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archieven</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recente berichten</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/01/14/dylib/">dylib动态库加载过程分析</a>
          </li>
        
          <li>
            <a href="/2017/01/13/macho/">Mach-O文件格式</a>
          </li>
        
          <li>
            <a href="/2017/01/12/install-software/">macOS平台软件的下载与安装</a>
          </li>
        
          <li>
            <a href="/2017/01/12/macos-software/">［置顶］macOS软件安全系列-软件内幕篇</a>
          </li>
        
          <li>
            <a href="/2017/01/11/new-chapter/">新的篇章</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">links</h3>
      <div class="widget">
      	<ul>
        	
          	<li class='link'><a href='https://ydc1992.github.io'>Ken&#39;s Blog</a></li>
        	
      	</ul>
      </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>